name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Tests et qualitÃ© code
  tests:
    name: Tests & Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite
          coverage: none

      - name: ğŸ“¦ Get Composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ Cache Composer dependencies
        uses: actions/cache@v3
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: ğŸ“¥ Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: ğŸ” Check Symfony requirements
        run: vendor/bin/requirements-checker
#
#      - name: âœ… Run Symfony security check
#        run: symfony security:check

      - name: ğŸ§¹ PHP CS Fixer (Code style)
        run: |
          composer require --dev friendsofphp/php-cs-fixer
          vendor/bin/php-cs-fixer fix --dry-run --diff
        continue-on-error: true

      - name: ğŸ“Š PHPStan (Static analysis)
        run: |
          composer require --dev phpstan/phpstan
          vendor/bin/phpstan analyse src --level=1
        continue-on-error: true

  # Job 2: Build et artifacts
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: tests
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'

      - name: ğŸ“¦ Install dependencies
        run: composer install --no-dev --optimize-autoloader
#
#      - name: ğŸ“¦ Create deployment artifact
#        run: |
#          mkdir -p artifacts
#          tar -czf artifacts/app.tar.gz \
#            --exclude='.git' \
#            --exclude='node_modules' \
#            --exclude='tests' \
#            --exclude='.env.local' \
#            .
#
#      - name: ğŸ“¤ Upload artifact
#        uses: actions/upload-artifact@v3
#        with:
#          name: symfony-app
#          path: artifacts/app.tar.gz
#          retention-days: 5

  # Job 3: Notification succÃ¨s
  notify:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [tests, build]
    if: success()
    
    steps:
      - name: ğŸ‰ Success notification
        run: |
          echo "âœ… CI/CD Pipeline completed successfully!"
          echo "ğŸš€ Ready for deployment"